# 02 | 느려진 서비스, 어디부터 봐야 할까

## DB 커넥션 풀
- 네트워크에서 DB를 연결하고 종료하는 시간은 전체 응답 시간에 영향을 줌.
- 매 요청마다 DB를 연결하고 종료하면 트래픽이 증가할 때 급격하게 처리량이 떨어짐.
- 이 문제를 해결하기 위해 DB 커넥션 풀을 사용함.
- DB 커넥션 풀은 DB에 연결된 커넥션을 미리 생성해서 보관함.
- 커넥션 풀을 사용하면 이미 연결된 커넥션을 재사용하기 때문에 응답 시간이 줄어드는 장점이 있음.
- 스프링 부트에는 데이터 소스라는 DB 커넥션 풀을 관리하는 인터페이스가 있고, 이 구현체 중 하나가 HikariCP임.

## 커넥션 풀 크기
- 커넥션 풀 크기 : 커넥션 풀에 미리 생성해둘 커넥션 개수를 지정하는 설정임.

![img.png](https://github.com/user-attachments/assets/1a65e257-9373-4c59-9697-085dcd72b3db)


- 커넥션 풀 크기가 5라면 서버에 6개의 요청이 들어왔을 때 이 중 5개 요청은 풀에서 커넥션을 가져올 수 있지만 1개 요청은 사용할 수 있는 커넥션이 없으므로 다른 요청이 커넥션 사용을 끝내고 풀에 반환할 때까지 기다려야 함.
- 커넥션 풀 크기를 늘리면 처리량을 높일 수 있지만 DB 서버의 CPU 사용률이 80%에 육박하는 상황에 커넥션 풀 크기를 늘리면 DB에 가해지는 부하가 더 커져 쿼리 실행 시간이 급격히 증가할 수 있음.
- 이러한 상태에서는 커넥션 풀 크기를 늘리기보다는 유지하거나 줄여서 DB 서버가 포화 상태에 이르지 않도록 하는 것이 좋음.

## 커넥션 대기 시간
- 대기 시간이란 풀에 사용할 수 있는 커넥션이 없을 때 커넥션을 얻기 위해 기다릴 수 있는 최대 시간을 의미함.
- 응답 시간이 중요한 서비스는 커넥션 대기 시간을 가능한 짧게 설정해야 함.
- 긴 시간 동안 무응답 상태로 유지되는것보다 빠르게 에러를 반환하는 것이 더 나음.
- 그리고 대기 시간을 짧게 설정하면 서버 부하를 일정 수준으로 유지할 수 있어서 서버를 안정적으로 운영하는데 도움이 됨.

## 최대 유휴 시간, 유효성 검사, 최대 유지 기간
- DB는 클라이언트와 일정 시간 동안 상호작용이 없으면 자동으로 연결을 끊는 기능을 제공함.
- DB와의 연결이 끊긴 커넥션을 사용하면 에러가 발생함. 이 에러를 방지하기 위해 커넥션 풀은 최대 유휴 시간 지정, 유효성 검사 지원 기능을 제공함.

### 최대 유휴 시간
- 사용되지 않는 커넥션을 풀에 유지할 수 있는 최대 시간을 의미
- 만약 30분으로 설정하면 30분 이상 사용되지 않은 커넥션은 종료되어 풀에서 제거됨.
- 이 시간을 DB에 설정된 비활성화 유지 시간보다 짧게 설정하면, DB가 연결을 끊기 전에 풀에서 커넥션을 제거할 수 있음.

### 유효성 검사
- 커넥션이 정상적으로 사용할 수 있는 상태인지 여부를 확인하는 절차
- 커넥션을 풀에서 가져올 때 유효성을 검사하거나 주기적으로 검사하고 연결이 유효하지 않은 커넥션을 식별하고 풀에서 제거할 수 있음.

### 최대 유지 기간
- 커넥션이 생성된 시점부터 최대로 유지할 수 있는 시간
- 예를 들어 4시간으로 설정하면, 커넥션은 생성된 시점부터 최대 4시간까지만 유지됨.
- 이때는 커넥션이 유효하더라도 커넥션을 닫고 풀에서 제거됨.

## HikariCP 주요 설정값

### 기본값
```yaml
spring:
   datasource:
     hikari:
       maximum-pool-size: 10           # 기본값: 10
       minimum-idle: 10                # 기본값: maximum-pool-size와 동일
       connection-timeout: 30000       # 기본값: 30초 (30,000ms)
       idle-timeout: 600000            # 기본값: 10분 (600,000ms)
       max-lifetime: 1800000           # 기본값: 30분 (1,800,000ms)
       leak-detection-threshold: 0     # 기본값: 비활성화 (0)
```
### 커넥션 누수 감지 설정
leak-detection-threshold를 60000 (1분)으로 설정하면 커넥션이 1분 이상 반환되지 않을 때 로그로 경고를 출력해서 커넥션 누수를 찾을 수 있음.
기본값 0은 비활성화 상태임.

### 프로덕션 권장 설정
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20-50        # 애플리케이션 규모에 따라
      minimum-idle: 5-10              # maximum-pool-size의 20-50%
      connection-timeout: 20000       # 20초
      idle-timeout: 300000            # 5분 (300,000ms)
      max-lifetime: 1200000           # 20분 (1,200,000ms)
      leak-detection-threshold: 60000 # 1분 (60,000ms)
```
- maximum-pool-size: 20-50
  - 동시 사용자 수와 트래픽 패턴을 고려하여 설정
  - 너무 크면 DB 커넥션 부족, 너무 작으면 대기시간 증가
  - 일반적으로 CPU 코어 수 × 2-4 정도가 적절
  - **모니터링을 통해 실제 사용량 기반으로 조정 필요**

- minimum-idle: 5-10
  - maximum-pool-size보다 작게 설정하여 리소스 효율성 확보
  - 트래픽이 적은 시간대에도 최소한의 연결을 유지
  - 갑작스런 트래픽 증가에 대응할 수 있는 여유분 확보

- connection-timeout: 20000 (20초)
  - 30초는 너무 길어서 사용자 경험 저하
  - 20초면 DB 문제 상황에서 적절한 타임아웃

- idle-timeout: 300000 (5분)
  - 10분은 너무 길어서 불필요한 커넥션 유지
  - 5분이면 일시적 트래픽 감소 시 적절한 정리
  - DB 리소스 절약과 성능의 균형점

- max-lifetime: 1200000 (20분)
  - 30분은 너무 길어서 DB 측 타임아웃에 걸릴 위험
  - 20분이면 안전하면서도 재연결 오버헤드 최소화
  - DB의 wait_timeout 설정보다 짧게 설정


## 읽어보면 좋을 자료
- [서버 증설 없이 처리하는 대규모 트래픽 - 토스](https://toss.tech/article/22563)
- [HikariCP Dead lock에서 벗어나기 - 우아한형제들](https://techblog.woowahan.com/2663/)

## 참고 자료
- [HikariCP GitHub 공식 문서](https://github.com/brettwooldridge/HikariCP?tab=readme-ov-file#essentials)
