# Appendix A | 처음 해보는 성능 테스트를 위한 기본 정리

## 주요 측정 지표

### 1. 응답 시간
- 사용자 체감 속도를 파악하게 함. 평균, 최대, 최소, 중앙, 95%나 99% 백분위 값을 측정함.
- **필수 측정값:** **95%나 99% 백분위(P95/P99)**.
- **분석 포인트:** 평균이 아닌 **P95/P99**를 통해 **느린 요청이 발생하는 빈도**를 파악하는 것이 가장 중요함.
    - (ex. P95가 2초라는 것은 전체 요청의 95%는 2초 이내에 응답했지만, 나머지 5%는 2초보다 훨씬 오래 걸렸다는 뜻임. 이 5%가 사용자 만족도를 크게 떨어지게 함.)

### 2. 처리량
- 시스템이 초당 처리 가능한 최대 용량(수용 능력)을 파악하게 함.
- **필수 측정값:** **최대 TPS** 또는 **RPS**.
- **분석 포인트:** 부하를 증가시켜 **처리량이 정점을 찍는 지점(`포화점`)** 을 찾음.
    - `버클존` : 포화점을 지나 성능(응답 시간)이 급격히 꺾이기 시작하는 구간임.

### 3. 에러율
- 부하 환경에서의 서비스 **안정성**을 파악하게 함.
- **필수 측정값:** 전체 요청 대비 실패한 요청(ex. HTTP 5xx)의 비율임.
- **분석 포인트:** 에러율이 **0%를 유지하는 선**을 안전 운영 가능한 최대 부하로 간주함. 처리량이 높아도 에러율이 상승하면 해당 시스템은 불안정한 상태임.

### 4. 자원 사용률
- 성능 저하의 **근본적인 원인(병목 지점)** 을 파악하게 함.
- **필수 측정값:** **CPU, 메모리, 디스크 I/O** 등 주요 자원의 사용률임.
- **분석 포인트:** CPU, 메모리, I/O 중 **90% 이상 사용되거나 급증하는 자원**이 현재 시스템의 **병목 지점**임. 이 자원을 집중적으로 최적화해야 함.


## 성능 테스트 도구
### Locust
<img src="./img/11_1.jpg" width=30%>

- 메뚜기 떼가 작물을 갉아먹듯이, 수많은 가상 사용자가 시스템에 요청을 쏟아붓는 부하를 시뮬레이션한다는 뜻임.
#### 부하 테스트 과정
- `locust` 라이브러리를 설치함.
    ```shell
    pip install locust
    ```
- 파이썬으로 코드를 작성
    ```python
    from locust import HttpUser, task, between
    
    class WebsiteUser(HttpUser):
        # 각 사용자가 작업을 수행한 후 1초에서 3초 사이를 대기합니다.
        wait_time = between(1, 3) 
        
        # 테스트 대상 서버의 기본 주소
        host = "http://localhost:8000" 
    
        # Task 1: 사용자 목록 조회 API 호출
        # @task 데코레이터의 괄호 안에 숫자를 넣어 가중치를 설정합니다.(확률적으로)
        @task(2) 
        def view_users(self):
            self.client.get("/api/users", name="View Users")
            
        # Task 2: 상품 상세 정보 조회 API 호출
        @task(1) 
        def view_products(self):
            self.client.get("/api/products/123", name="View Product Detail")
    ```
- 코드 실행
    ```shell
    locust -f app.py
    ```
    <img src="./img/11_2.png" width="4500px">
    
  ![img.png](img/11_3.png)

  - 여기서 `Number of users`는 부하가 도달할 최종 목표치, `Ramp up`은 부하를 서서히 높이는 속도임.
  - 만약 최대 사용자를 100명, Ramp up을 10으로 설정했다면 ➡️ 100 / 10 = 10초 만에 100명의 사용자 부하에 도달하게 됨.

- 실행 결과 화면
  ![img.png](img/11_4.png)

### k6
- 엔진이 **Go 언어**로 작성되어 있고, **고루틴** 을 사용해 더 적은 자원으로 **더 많은 부하**를 효율적으로 발생시킬 수 있음.
- 부하 테스트 코드는 **JavaScript** 를 이용해서 작성함.
- 테스트 결과를 **Grafana**와 연동해서 실시간으로 모니터링하고 시각화할 수 있음.